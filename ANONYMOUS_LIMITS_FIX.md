# Виправлення лімітів для анонімних користувачів

## Проблеми, які були виправлені:

### 1. **Нестабільний Device ID**
- **Проблема:** Device ID міг змінюватися при перезавантаженні додатку
- **Рішення:** Використання Crypto (SHA256) та SecureStore для стабільного збереження

### 2. **Скидання лімітів при перезавантаженні**
- **Проблема:** Ліміти скидалися при кожному перезавантаженні
- **Рішення:** Покращено логіку збереження та відновлення device_id

### 3. **Помилки при створенні анонімних користувачів**
- **Проблема:** Дублікати та помилки вставки
- **Рішення:** Додано fallback логіку та кращу обробку помилок

### 4. **Автоматичне скидання лімітів через час**
- **Проблема:** Ліміти скидалися через 5 хвилин через перезавантаження
- **Рішення:** Додано перевірку для запобігання непотрібних перезавантажень

## Що змінено:

### 1. **Стабільний Device ID**
```typescript
// Використання Crypto (SHA256) та SecureStore для стабільного збереження
const getStableDeviceId = async (): Promise<string> => {
  let deviceId = await SecureStore.getItemAsync('device_id');
  if (!deviceId) {
    const hash = await digestStringAsync(
      CryptoDigestAlgorithm.SHA256, 
      Date.now().toString() + Math.random().toString()
    );
    deviceId = 'anon_' + hash.slice(0, 16); // укорочений UUID-like
    await SecureStore.setItemAsync('device_id', deviceId);
  }
  return deviceId;
};
```

### 2. **Fallback логіка**
- Якщо не вдається створити користувача в базі даних
- Використовуються локальні ліміти
- Логування для діагностики

### 3. **Краща обробка помилок**
- Перевірка на дублікати
- Повторні спроби завантаження
- Fallback ліміти при помилках

### 4. **Запобігання автоматичному скиданню**
- Перевірка перед перезавантаженням лімітів
- Ліміти завантажуються тільки при необхідності
- Функція `refreshLimits()` для примусового оновлення
- Стан `hasLoaded` для запобігання повторних завантажень

### 5. **Використання upsert для anonymous_users**
- Заміна `.update()` на `.upsert()` для надійності
- Автоматичне створення записів, якщо їх немає
- Оновлення існуючих записів без помилок

## Тестування:

### 1. **Перезавантаження додатку**
- Ліміти повинні зберігатися
- Device ID повинен залишатися стабільним

### 2. **Очищення кешу**
- Device ID повинен відновлюватися
- Ліміти повинні зберігатися

### 3. **Перехід між додатками**
- Ліміти повинні зберігатися
- Не повинно бути скидання

### 4. **Перезапуск пристрою**
- Device ID повинен відновлюватися
- Ліміти повинні зберігатися

### 5. **Очікування протягом часу**
- Ліміти НЕ повинні скидатися через 5 хвилин
- Ліміти НЕ повинні скидатися при перезавантаженні додатку

### 6. **Надійність бази даних**
- Використання `upsert` замість `update` для anonymous_users
- Автоматичне створення записів при першому використанні
- Відсутність помилок при одночасних операціях

### 7. **Стабільне збереження Device ID**
- Використання Crypto (SHA256) для унікальних ідентифікаторів
- SecureStore для безпечного збереження
- Fallback до AsyncStorage при помилках
- Кешування в пам'яті для швидкого доступу

## Логи для перевірки:

Шукайте в консолі:
- `"Generated new device ID (Crypto):"` - новий ID через Crypto
- `"Using existing device ID from SecureStore:"` - існуючий ID
- `"Generated fallback device ID:"` - fallback ID
- `"Loading anonymous user limits for device:"`
- `"Anonymous user limits loaded:"`
- `"Limits already loaded, skipping reload"` - якщо ліміти не перезавантажуються

## Якщо проблема залишається:

1. **Перевірте логи** - чи генерується стабільний device_id
2. **Перевірте базу даних** - чи зберігаються записи в `anonymous_users`
3. **Перевірте AsyncStorage** - чи зберігається device_id локально 