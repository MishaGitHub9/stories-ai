# Виправлення помилки дублікатів device_id

## Проблема
Ви отримуєте помилку:
```
ERROR: duplicate key value violates unique constraint "anonymous_users_device_id_key"
Key (device_id)=(BP22.250325.006) already exists.
```

Це означає, що в таблиці `anonymous_users` є дублікати записів з однаковим `device_id`.

## Рішення

### Крок 1: Виправлення дублікатів в базі даних

1. **Відкрийте Supabase Dashboard**
2. **Перейдіть до SQL Editor**
3. **Видаліть весь попередній код з редактора**
4. **Виконайте оновлений скрипт `database/fix_duplicates.sql`**

Цей скрипт:
- Знайде всі дублікати
- Видалить зайві записи, залишивши тільки найновіший (за `created_at`)
- Додасть унікальний індекс для запобігання майбутніх дублікатів

### Крок 2: Оновлення коду

Я вже оновив код в `hooks/useLimits.ts` для кращої обробки цієї ситуації:

1. **Покращена логіка отримання device_id** - тепер використовує більше джерел для створення унікального ID
2. **Обробка помилок дублікатів** - якщо виникає помилка вставки, код спробує знову завантажити існуючий запис
3. **Більш стабільні ID** - додано випадкові компоненти для унікальності

### Крок 3: Перевірка

Після виконання скрипта перевірте:

```sql
-- Перевірте, що дублікатів більше немає
SELECT device_id, COUNT(*) as count
FROM anonymous_users
GROUP BY device_id
HAVING COUNT(*) > 1;

-- Перевірте загальну кількість записів
SELECT COUNT(*) as total_anonymous_users FROM anonymous_users;
```

## Причини виникнення проблеми

1. **Паралельні запити** - кілька компонентів одночасно намагаються створити запис
2. **Нестабільний device_id** - різні запуски додатку генерували однаковий ID
3. **Відсутність унікального індексу** - база даних не перевіряла унікальність

## Запобігання в майбутньому

### 1. Унікальний індекс
Тепер в таблиці є унікальний індекс на `device_id`, який запобігає створенню дублікатів.

### 2. Покращена логіка в коді
- Обробка помилок дублікатів
- Більш стабільні ID пристроїв
- Повторні спроби завантаження

### 3. Upsert операції
Можна також використовувати `upsert` замість `insert`:

```sql
INSERT INTO anonymous_users (device_id, stories_generated_today, messages_sent_today, last_reset_date)
VALUES ($1, $2, $3, $4)
ON CONFLICT (device_id) 
DO UPDATE SET 
  stories_generated_today = EXCLUDED.stories_generated_today,
  messages_sent_today = EXCLUDED.messages_sent_today,
  last_reset_date = EXCLUDED.last_reset_date;
```

## Тестування

Після виправлення протестуйте:

1. **Перезапустіть додаток**
2. **Спробуйте створити кілька історій**
3. **Перевірте, що ліміти правильно відстежуються**
4. **Перевірте, що помилки дублікатів не з'являються**

## Альтернативне рішення

Якщо проблема повторюється, можна використати більш агресивний підхід:

```sql
-- Видалити всі записи anonymous_users і почати заново
DELETE FROM anonymous_users;
```

**⚠️ УВАГА: Це видалить всі дані анонімних користувачів!**

## Підтримка

Якщо проблема залишається:

1. Перевірте логи в Supabase Dashboard
2. Переконайтеся, що скрипт виправлення виконано успішно
3. Перевірте, що код оновлено
4. Спробуйте очистити кеш AsyncStorage в додатку 